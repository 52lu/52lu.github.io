---
title: Kubernetes-搭建篇-公共镜像搭建
date: 2019-12-13 01:02:56
tags:
 - Kubernetes
categories:
 - docker
---


# 1.环境总览
## 1.1 镜像环境
- 操作系统: Centos7.7
- Docker版本: Docker 19.03.5.ce
- Kubernetes: v1.17.0


# 2.下载镜像

```
docker pull centos:centos7
```
# 3. 启动容器
- 以特权模式身份启动容器,并把容器名命名为:centos7_k8s_common;

```
➜ docker run -d --name centos7_k8s_common --privileged=true centos:centos7 /usr/sbin/init
```
> 大约在0.6版，privileged被引入docker。使用该参数，container内的root拥有真正的root权限。 否则，container内的root只是外部的一个普通用户权限

- 进入容器

```
➜  docker exec -it centos7_k8s_common bash
```

# 4. 容器环境设置
Kubernetes的正确运行依赖于一些基础环境的设定，如各节点时间通过网络时间服务保持同步和主机名称解析等，集群规模较大的实践场景中，主机名称解析通常由DNS服务器完成。本测试示例中，时间同步服务直接基于系统的默认配置从互联网的时间服务中获取，主机名称解析则由hosts文件进行。

## 4.1 修改时区

```
# 查看当前时区
[root@4a39c2a2b3e5 /]# timedatectl
      Local time: Thu 2019-12-12 06:24:49 UTC
  Universal time: Thu 2019-12-12 06:24:49 UTC
        RTC time: Thu 2019-12-12 06:24:49
       Time zone: UTC (UTC, +0000)
     NTP enabled: n/a
NTP synchronized: no
 RTC in local TZ: no
      DST active: n/a
      
# 修改时区
[root@4a39c2a2b3e5 /]# timedatectl set-timezone Asia/Shanghai

# 查看修改后时区
[root@4a39c2a2b3e5 /]# timedatectl
      Local time: Thu 2019-12-12 14:25:16 CST
  Universal time: Thu 2019-12-12 06:25:16 UTC
        RTC time: Thu 2019-12-12 06:25:16
       Time zone: Asia/Shanghai (CST, +0800)
     NTP enabled: n/a
NTP synchronized: no
 RTC in local TZ: no
      DST active: n/a
[root@4a39c2a2b3e5 /]#
```


## 4.2 关闭防火墙服务
各Node运行的kube-proxy组件均要借助iptables或ipvs构建Service资源对象，该资源对象是Kubernetes的核心资源之一。出于简化问题复杂度之需，这里需要事先关闭所有主机之上的iptables或firewalld服务：

[具体查看在Centos7中如何关闭防火墙](https://52lu.github.io/2015/08/17/close-firewalld/)

<font color=red> 因为下载的镜像中，没有防火墙服务故无需操作，最好验证下</font>

## 4.3 关闭并禁用SELinux

- 临时关闭

```
setenforce 0
```
- 永久关闭
编辑/etc/sysconfig/selinux文件，以彻底禁用SELinux。
```
[root@4a39c2a2b3e5 /]#  sed -i 's@^\(SELINUX=\).*@\1disabled@' /etc/sysconfig/selinux
```

## 4.4 禁用Swap设备
kubeadm默认会预先检查当前主机是否禁用了Swap设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的Swap设备。
关闭Swap设备，需要分两步完成。
- 第一步:关闭交换空间

```
[root@4a39c2a2b3e5 /]# swapoff -a
```
- 第二步:关闭交换空间

注释 /etc/fstab 中的 swap


# 5. 安装服务
## 5.1 安装docker
- 安装依赖

```
[root@4a39c2a2b3e5 /]# yum -y install yum-utils device-mapper-persistent-data lvm2
```
- 添加官方yum库

```
[root@4a39c2a2b3e5 /]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```
- 安装docker

```
[root@4a39c2a2b3e5 /]#  yum -y install docker-ce
```

- 设置开机启动

```
//开机启动
[root@4a39c2a2b3e5 /]# systemctl enable docker
```

## 5.2 修改docker cgroup驱动
修改docker cgroup驱动，与kubelet一致,
```
[root@4a39c2a2b3e5 /]# cat > /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  }
}
EOF
```

## 5.3 安装Kubernetes组件

### 5.3.1 配置k8s源
```
[root@4a39c2a2b3e5 /]# cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
EOF
```

### 5.3.2 安装kubelet、kubeadm、kubectl

```
[root@4a39c2a2b3e5 /]# yum -y install kubelet kubeadm kubectl
```

- kubeadm：用于初始化 Kubernetes 集群
- kubectl：Kubernetes 的命令行工具，主要作用是部署和管理应用，查看各种资源，创建，删除和更新组件
- kubelet：主要负责启动 Pod 和容器



### 5.3.3 配置kubelet

- 设置启动参数

Kubernetes自1.8版本起强制要求关闭系统上的交换分区（Swap），否则kubelet将无法启动。用户也可以通过将kubelet的启动参数“--fail-swap-on”设置为“false”忽略此限制。

**忽略方法:** 编辑kubelet的配置文件/etc/sysconfig/kubelet
```
KUBELET_EXTRA_ARGS="--fail-swap-on=false"
```

- 设定kubelet开机启动

需要设定kubelet服务开机自动启动，这也是kubeadm的强制要求。
```
[root@4a39c2a2b3e5 /]# systemctl enable kubelet.service
```


### 5.3.4 配置kubeadm

- 导出配置文件:kubeadm.yml

```
[root@4a39c2a2b3e5 kubernetes]# kubeadm config print init-defaults --kubeconfig ClusterConfiguration > kubeadm.yml
```

**kubeadm.yml文件内容**
```
apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  # 修改1: 此处要设置为master的Ip
  advertiseAddress: 172.17.0.2
  bindPort: 6443
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: 2e6c8d013da6
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
# 修改2: 国内不能访问 Google，修改为阿里云
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
# 修改3: 确认版本号是否与本地kubernetes版本一致
kubernetesVersion: v1.17.0
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12
scheduler: {}
```


- 修改kubeadm.yml配置文件

**修改为主节点IP**
```
...
localAPIEndpoint:
  # 修改1: 此处要设置为master的Ip
  advertiseAddress: 172.17.0.2
  bindPort: 6443
...
```

**修改下载源**
```
....
etcd:
  local:
    dataDir: /var/lib/etcd
# 修改2: 国内不能访问 Google，修改为阿里云
imageRepository: registry.aliyuncs.com/google_containers
kind: ClusterConfiguration
...
```
**确认版本号是否一致**

```
# 确认版本号是否与本地kubernetes版本一致
kubernetesVersion: v1.17.0

# 查看本地kubernetes版
[root@4a39c2a2b3e5 kubernetes]# kubectl version
Client Version: version.Info{Major:"1", Minor:"17", GitVersion:"v1.17.0", GitCommit:"70132b0f130acc0bed193d9ba59dd186f0e634cf", GitTreeState:"clean", BuildDate:"2019-12-07T21:20:10Z", GoVersion:"go1.13.4", Compiler:"gc", Platform:"linux/amd64"}
```


### 5.3.5 查看和拉取镜像

**查看所需镜像列表**
```
[root@2e6c8d013da6 kubernetes]# kubeadm config images list --config kubeadm.yml
W1213 00:31:13.339068     942 validation.go:28] Cannot validate kube-proxy config - no validator is available
W1213 00:31:13.339123     942 validation.go:28] Cannot validate kubelet config - no validator is available
registry.aliyuncs.com/google_containers/kube-apiserver:v1.17.0
registry.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0
registry.aliyuncs.com/google_containers/kube-scheduler:v1.17.0
registry.aliyuncs.com/google_containers/kube-proxy:v1.17.0
registry.aliyuncs.com/google_containers/pause:3.1
registry.aliyuncs.com/google_containers/etcd:3.4.3-0
registry.aliyuncs.com/google_containers/coredns:1.6.5
```

**拉取镜像**
```
[root@2e6c8d013da6 kubernetes]# kubeadm config images pull --config kubeadm.yml
W1213 00:33:37.517797     953 validation.go:28] Cannot validate kubelet config - no validator is available
W1213 00:33:37.517845     953 validation.go:28] Cannot validate kube-proxy config - no validator is available
[config/images] Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.17.0
[config/images] Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.17.0
[config/images] Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.17.0
[config/images] Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.17.0
[config/images] Pulled registry.aliyuncs.com/google_containers/pause:3.1
[config/images] Pulled registry.aliyuncs.com/google_containers/etcd:3.4.3-0
[config/images] Pulled registry.aliyuncs.com/google_containers/coredns:1.6.5
```
<font color=red> 出现 Cannot validate kubelet警告信息，可以忽视，不影响下载镜像!</font>


**查看镜像**
```
[root@2e6c8d013da6 kubernetes]# docker images
REPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE
registry.aliyuncs.com/google_containers/kube-proxy                v1.17.0             7d54289267dc        4 days ago          116MB
registry.aliyuncs.com/google_containers/kube-apiserver            v1.17.0             0cae8d5cc64c        4 days ago          171MB
registry.aliyuncs.com/google_containers/kube-controller-manager   v1.17.0             5eb3b7486872        4 days ago          161MB
registry.aliyuncs.com/google_containers/kube-scheduler            v1.17.0             78c190f736b1        4 days ago          94.4MB
registry.aliyuncs.com/google_containers/coredns                   1.6.5               70f311871ae1        5 weeks ago         41.6MB
registry.aliyuncs.com/google_containers/etcd                      3.4.3-0             303ce5db0e90        6 weeks ago         288MB
registry.aliyuncs.com/google_containers/pause                     3.1                 da86e6ba6ca1        24 months ago       742kB
```

# 6.上传镜像

## 6.1 提交镜像
```
[root@serve01 ~ ]$ docker commit 2e6c8d013da6 liuqinghui/centos7_k8s_common
sha256:63ba9ec05ade7063ba6b1e6bacb5360203744637e8ed84d04ca61b5456081bad
```

## 6.2 登陆到docker
```
[root@serve01 ~ ]$ docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.
Username: liuqinghui
Password:

```

## 6.3 推送镜像
```
[root@serve01 ~ ]$ docker push liuqinghui/centos7_k8s_common
```

到此基础镜像搭建完毕，后续请看集群初始化。